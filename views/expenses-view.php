<!-- Expenses Section v·ªõi Tailwind CSS -->
<div class="space-y-8">
    <!-- Header v·ªõi n√∫t th√™m chi ti√™u -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
            <h3 class="text-2xl font-bold text-gray-800">Qu·∫£n l√Ω chi ti√™u</h3>
            <p class="text-gray-600">Theo d√µi v√† ki·ªÉm so√°t chi ti√™u c√° nh√¢n</p>
        </div>
        <button onclick="showAddExpenseForm()"
            class="bg-gradient-to-r from-red-500 to-pink-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-red-600 hover:to-pink-700 transition-all duration-200 flex items-center space-x-2 shadow-lg">
            <i class="fas fa-plus"></i>
            <span>Th√™m chi ti√™u</span>
        </button>
    </div>

    <!-- Th·ªëng k√™ t·ªïng quan -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="expense-stats">
        <!-- T·ªïng chi ti√™u th√°ng -->
        <div class="bg-gradient-to-br from-red-400 to-red-600 text-white p-6 rounded-2xl shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-red-100 text-sm font-medium">T·ªïng chi ti√™u th√°ng n√†y</p>
                    <p class="text-2xl font-bold mt-1" id="monthly-total">0 VNƒê</p>
                </div>
                <div class="bg-white bg-opacity-20 p-3 rounded-full">
                    <i class="fas fa-chart-line text-2xl text-white"></i>
                </div>
            </div>
        </div>

        <!-- Chi ti√™u h√¥m nay -->
        <div class="bg-gradient-to-br from-blue-400 to-blue-600 text-white p-6 rounded-2xl shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-blue-100 text-sm font-medium">Chi ti√™u h√¥m nay</p>
                    <p class="text-2xl font-bold mt-1" id="today-total">0 VNƒê</p>
                </div>
                <div class="bg-white bg-opacity-20 p-3 rounded-full">
                    <i class="fas fa-calendar-day text-2xl text-white"></i>
                </div>
            </div>
        </div>

        <!-- Trung b√¨nh chi ti√™u -->
        <div class="bg-gradient-to-br from-green-400 to-green-600 text-white p-6 rounded-2xl shadow-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-green-100 text-sm font-medium">Trung b√¨nh/ng√†y</p>
                    <p class="text-2xl font-bold mt-1" id="avg-amount">0 VNƒê</p>
                </div>
                <div class="bg-white bg-opacity-20 p-3 rounded-full">
                    <i class="fas fa-calculator text-2xl text-white"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Form th√™m chi ti√™u (·∫©n m·∫∑c ƒë·ªãnh) -->
    <div id="add-expense-form" class="hidden bg-gradient-to-br from-red-50 to-pink-50 border border-red-200 rounded-2xl p-8 shadow-lg">
        <div class="flex justify-between items-center mb-6">
            <h4 class="text-xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-plus-circle mr-3 text-red-500"></i>
                Th√™m chi ti√™u m·ªõi
            </h4>
            <button onclick="hideAddExpenseForm()" class="text-gray-500 hover:text-gray-700 p-2">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <form id="expense-form" class="space-y-6">
            <!-- M√¥ t·∫£ v√† s·ªë ti·ªÅn -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="expense-title" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-file-text mr-2"></i>M√¥ t·∫£ *
                    </label>
                    <input type="text" id="expense-title" name="title" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200"
                        placeholder="VD: ƒÇn tr∆∞a, xe bus, mua s√°ch...">
                </div>

                <div>
                    <label for="expense-amount" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-money-bill mr-2"></i>S·ªë ti·ªÅn (VNƒê) *
                    </label>
                    <input type="number" id="expense-amount" name="amount" min="0" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200"
                        placeholder="Nh·∫≠p s·ªë ti·ªÅn...">
                </div>
            </div>

            <!-- Danh m·ª•c v√† ng√†y -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="expense-category" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-tags mr-2"></i>Danh m·ª•c *
                    </label>
                    <select id="expense-category" name="category" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200">
                        <option value="">Ch·ªçn danh m·ª•c</option>
                        <option value="food">üçú ƒÇn u·ªëng</option>
                        <option value="transport">üöå Di chuy·ªÉn</option>
                        <option value="education">üìö H·ªçc t·∫≠p</option>
                        <option value="entertainment">üé¨ Gi·∫£i tr√≠</option>
                        <option value="shopping">üõí Mua s·∫Øm</option>
                        <option value="health">üè• Y t·∫ø</option>
                        <option value="other">üìù Kh√°c</option>
                    </select>
                </div>

                <div>
                    <label for="expense-date" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar mr-2"></i>Ng√†y *
                    </label>
                    <input type="date" id="expense-date" name="date" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200">
                </div>
            </div>

            <!-- Ghi ch√∫ -->
            <div>
                <label for="expense-note" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-sticky-note mr-2"></i>Ghi ch√∫ (t√πy ch·ªçn)
                </label>
                <textarea id="expense-note" name="note" rows="3"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200 resize-vertical"
                    placeholder="Ghi ch√∫ th√™m v·ªÅ chi ti√™u n√†y..."></textarea>
            </div>

            <!-- N√∫t action -->
            <div class="flex items-center justify-end space-x-4 pt-4">
                <button type="button" onclick="hideAddExpenseForm()"
                    class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all duration-200">
                    H·ªßy
                </button>
                <button type="submit"
                    class="bg-gradient-to-r from-red-500 to-pink-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-red-600 hover:to-pink-700 transition-all duration-200 flex items-center space-x-2">
                    <i class="fas fa-save"></i>
                    <span>Th√™m chi ti√™u</span>
                </button>
            </div>
        </form>
    </div>

    <!-- B·ªô l·ªçc -->
    <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-lg">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- L·ªçc danh m·ª•c -->
            <div>
                <label for="filter-expense-category" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-filter mr-2"></i>L·ªçc theo danh m·ª•c
                </label>
                <select id="filter-expense-category" onchange="filterExpenses()"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                    <option value="">T·∫•t c·∫£ danh m·ª•c</option>
                    <option value="food">üçú ƒÇn u·ªëng</option>
                    <option value="transport">üöå Di chuy·ªÉn</option>
                    <option value="education">üìö H·ªçc t·∫≠p</option>
                    <option value="entertainment">üé¨ Gi·∫£i tr√≠</option>
                    <option value="shopping">üõí Mua s·∫Øm</option>
                    <option value="health">üè• Y t·∫ø</option>
                    <option value="other">üìù Kh√°c</option>
                </select>
            </div>

            <!-- L·ªçc th√°ng -->
            <div>
                <label for="filter-month" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-calendar-alt mr-2"></i>L·ªçc theo th√°ng
                </label>
                <input type="month" id="filter-month" onchange="filterExpenses()"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
            </div>
        </div>
    </div>

    <!-- Danh s√°ch chi ti√™u -->
    <div class="space-y-4" id="expenses-list">
        <!-- Loading state -->
        <div class="text-center py-12" id="loading-expenses">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-500 mx-auto mb-4"></div>
            <span class="text-gray-600">ƒêang t·∫£i danh s√°ch chi ti√™u...</span>
        </div>

        <!-- Empty state n·∫øu kh√¥ng c√≥ chi ti√™u -->
        <div class="text-center py-12 text-gray-500" id="no-expenses" style="display: none;">
            <i class="fas fa-wallet text-6xl mb-4 text-gray-300"></i>
            <h3 class="text-xl font-semibold mb-2">Ch∆∞a c√≥ chi ti√™u n√†o</h3>
            <p class="mb-4">H√£y th√™m chi ti√™u ƒë·∫ßu ti√™n c·ªßa b·∫°n!</p>
            <button onclick="showAddExpenseForm()"
                class="bg-gradient-to-r from-red-500 to-pink-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-red-600 hover:to-pink-700 transition-all duration-200">
                Th√™m chi ti√™u ngay
            </button>
        </div>
    </div>

    <!-- Bi·ªÉu ƒë·ªì chi ti√™u -->
    <div class="bg-white border border-gray-200 rounded-2xl p-8 shadow-lg">
        <h4 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
            <i class="fas fa-chart-pie mr-3 text-blue-500"></i>
            Bi·ªÉu ƒë·ªì chi ti√™u theo danh m·ª•c
        </h4>
        <div class="bg-gradient-to-br from-gray-50 to-blue-50 border-2 border-dashed border-gray-300 rounded-xl p-12 text-center">
            <i class="fas fa-chart-bar text-6xl text-gray-400 mb-4"></i>
            <p class="text-gray-600 text-lg font-medium mb-2">Bi·ªÉu ƒë·ªì s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y</p>
            <p class="text-gray-500">C·∫ßn t√≠ch h·ª£p Chart.js ho·∫∑c library bi·ªÉu ƒë·ªì kh√°c</p>
        </div>
    </div>
</div>

<!-- JavaScript cho Expenses -->
<script>
    // Bi·∫øn global
    let currentExpenses = [];
    let currentFilters = {
        category: '',
        month: new Date().toISOString().slice(0, 7) // Format: YYYY-MM
    };

    // Kh·ªüi t·∫°o khi trang load
    document.addEventListener('DOMContentLoaded', function() {
        loadExpenseStats();
        loadExpensesList();

        // Set th√°ng hi·ªán t·∫°i cho filter
        document.getElementById('filter-month').value = currentFilters.month;
    });

    /**
     * Load th·ªëng k√™ chi ti√™u
     */
    async function loadExpenseStats() {
        try {
            const response = await fetch(`api/expenses-api.php?action=stats&month=${currentFilters.month}`);
            const data = await response.json();

            if (data.success) {
                updateStatsDisplay(data.data);
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    /**
     * C·∫≠p nh·∫≠t hi·ªÉn th·ªã th·ªëng k√™
     */
    function updateStatsDisplay(stats) {
        document.getElementById('monthly-total').textContent = stats.monthly.total_amount_formatted;
        document.getElementById('today-total').textContent = stats.today.today_amount_formatted;
        document.getElementById('avg-amount').textContent = stats.monthly.avg_amount_formatted;
    }

    /**
     * Load danh s√°ch chi ti√™u
     */
    async function loadExpensesList() {
        const loadingEl = document.getElementById('loading-expenses');
        const listEl = document.getElementById('expenses-list');

        try {
            loadingEl.style.display = 'block';

            const params = new URLSearchParams({
                action: 'list',
                category: currentFilters.category,
                month: currentFilters.month
            });

            const response = await fetch(`api/expenses-api.php?${params}`);
            const data = await response.json();

            if (data.success) {
                currentExpenses = data.data;
                renderExpensesList(data.data);
            }
        } catch (error) {
            console.error('Error loading expenses:', error);
            showError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch chi ti√™u');
        } finally {
            loadingEl.style.display = 'none';
        }
    }

    /**
     * Render danh s√°ch chi ti√™u
     */
    function renderExpensesList(expenses) {
        const listEl = document.getElementById('expenses-list');
        const emptyEl = document.getElementById('no-expenses');

        // X√≥a loading v√† empty state
        const loadingEl = document.getElementById('loading-expenses');
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'none';

        if (expenses.length === 0) {
            emptyEl.style.display = 'block';
            return;
        }

        const expensesHtml = expenses.map(expense => createExpenseCard(expense)).join('');
        listEl.innerHTML = expensesHtml;
    }

    /**
     * T·∫°o HTML cho m·ªôt kho·∫£n chi
     */
    function createExpenseCard(expense) {
        const categoryIcons = {
            'food': 'fas fa-utensils',
            'transport': 'fas fa-bus',
            'education': 'fas fa-book',
            'entertainment': 'fas fa-film',
            'shopping': 'fas fa-shopping-bag',
            'health': 'fas fa-heartbeat',
            'other': 'fas fa-receipt'
        };

        const categoryColors = {
            'food': 'orange',
            'transport': 'blue',
            'education': 'purple',
            'entertainment': 'pink',
            'shopping': 'green',
            'health': 'red',
            'other': 'gray'
        };

        const categoryLabels = {
            'food': 'üçú ƒÇn u·ªëng',
            'transport': 'üöå Di chuy·ªÉn',
            'education': 'üìö H·ªçc t·∫≠p',
            'entertainment': 'üé¨ Gi·∫£i tr√≠',
            'shopping': 'üõí Mua s·∫Øm',
            'health': 'üè• Y t·∫ø',
            'other': 'üìù Kh√°c'
        };

        const icon = categoryIcons[expense.category] || 'fas fa-receipt';
        const color = categoryColors[expense.category] || 'gray';
        const label = categoryLabels[expense.category] || 'üìù Kh√°c';

        return `
            <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300" data-category="${expense.category}" data-id="${expense.id}">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <!-- Th√¥ng tin chi ti√™u -->
                    <div class="flex-1">
                        <div class="flex items-center space-x-3 mb-2">
                            <div class="w-10 h-10 bg-${color}-100 text-${color}-600 rounded-full flex items-center justify-center">
                                <i class="${icon}"></i>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold text-gray-800">${expense.title}</h4>
                                <p class="text-sm text-gray-500">${label} ‚Ä¢ ${expense.expense_date_formatted}</p>
                            </div>
                        </div>
                        ${expense.description ? `<p class="text-gray-600 text-sm ml-13">${expense.description}</p>` : ''}
                    </div>

                    <!-- S·ªë ti·ªÅn v√† actions -->
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-2xl font-bold text-red-600">${expense.amount_formatted.replace(' VNƒê', '')}</p>
                            <p class="text-sm text-gray-500">VNƒê</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editExpense(${expense.id})"
                                class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-50 transition-all duration-200">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteExpense(${expense.id})"
                                class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-50 transition-all duration-200">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * Hi·ªÉn th·ªã form th√™m chi ti√™u
     */
    function showAddExpenseForm() {
        const form = document.getElementById('add-expense-form');
        form.classList.remove('hidden');
        form.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
        document.getElementById('expense-title').focus();

        // Set ng√†y hi·ªán t·∫°i l√†m m·∫∑c ƒë·ªãnh
        document.getElementById('expense-date').value = new Date().toISOString().split('T')[0];
    }

    /**
     * ·∫®n form th√™m chi ti√™u
     */
    function hideAddExpenseForm() {
        const form = document.getElementById('add-expense-form');
        form.classList.add('hidden');
        document.getElementById('expense-form').reset();
    }

    /**
     * L·ªçc chi ti√™u theo category v√† th√°ng
     */
    function filterExpenses() {
        currentFilters.category = document.getElementById('filter-expense-category').value;
        currentFilters.month = document.getElementById('filter-month').value;

        loadExpenseStats();
        loadExpensesList();
    }

    /**
     * S·ª≠a chi ti√™u
     */
    function editExpense(id) {
        const expense = currentExpenses.find(e => e.id == id);
        if (!expense) {
            showError('Kh√¥ng t√¨m th·∫•y chi ti√™u');
            return;
        }

        // TODO: Implement edit modal
        alert(`S·ª≠a chi ti√™u: ${expense.title}`);
    }

    /**
     * X√≥a chi ti√™u
     */
    async function deleteExpense(id) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a chi ti√™u n√†y?')) {
            return;
        }

        try {
            const response = await fetch(`api/expenses-api.php?action=delete&id=${id}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                showSuccess('ƒê√£ x√≥a chi ti√™u th√†nh c√¥ng');
                loadExpenseStats();
                loadExpensesList();
            } else {
                showError(data.error || 'Kh√¥ng th·ªÉ x√≥a chi ti√™u');
            }
        } catch (error) {
            console.error('Error deleting expense:', error);
            showError('Kh√¥ng th·ªÉ x√≥a chi ti√™u');
        }
    }

    /**
     * Format s·ªë ti·ªÅn VNƒê
     */
    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN').format(amount) + ' VNƒê';
    }

    /**
     * X·ª≠ l√Ω submit form
     */
    document.getElementById('expense-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;

        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang l∆∞u...';

            // L·∫•y d·ªØ li·ªáu form
            const formData = new FormData(this);
            const expenseData = {
                title: formData.get('title'),
                amount: parseFloat(formData.get('amount')),
                category: formData.get('category'),
                expense_date: formData.get('date'),
                description: formData.get('note')
            };

            const response = await fetch('api/expenses-api.php?action=add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(expenseData)
            });

            const data = await response.json();

            if (data.success) {
                showSuccess('Th√™m chi ti√™u th√†nh c√¥ng!');
                hideAddExpenseForm();
                loadExpenseStats();
                loadExpensesList();
            } else {
                showError(data.error || 'Kh√¥ng th·ªÉ th√™m chi ti√™u');
            }
        } catch (error) {
            console.error('Error adding expense:', error);
            showError('Kh√¥ng th·ªÉ th√™m chi ti√™u');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });

    /**
     * Format s·ªë ti·ªÅn trong input
     */
    document.getElementById('expense-amount').addEventListener('input', function(e) {
        // Lo·∫°i b·ªè k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
        this.value = this.value.replace(/[^0-9]/g, '');
    });

    /**
     * Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
     */
    function showSuccess(message) {
        // T·∫°o toast notification
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full';
        toast.innerHTML = `
            <div class="flex items-center space-x-2">
                <i class="fas fa-check-circle"></i>
                <span>${message}</span>
            </div>
        `;

        document.body.appendChild(toast);

        // Hi·ªÉn th·ªã toast
        setTimeout(() => {
            toast.classList.remove('translate-x-full');
        }, 100);

        // ·∫®n toast sau 3 gi√¢y
        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }

    /**
     * Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
     */
    function showError(message) {
        // T·∫°o toast notification
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full';
        toast.innerHTML = `
            <div class="flex items-center space-x-2">
                <i class="fas fa-exclamation-circle"></i>
                <span>${message}</span>
            </div>
        `;

        document.body.appendChild(toast);

        // Hi·ªÉn th·ªã toast
        setTimeout(() => {
            toast.classList.remove('translate-x-full');
        }, 100);

        // ·∫®n toast sau 3 gi√¢y
        setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }
</script>